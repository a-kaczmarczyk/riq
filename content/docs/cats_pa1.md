---
title: "Designing a Power Amplifier for CATS: Part 1"
date: 2024-01-08T20:38:00-05:00
draft: false
---
My friend and fellow ham Stephen Downward VE9QLE has been hard at work developing hardware and software for a digital packet mode he is calling [CATS][], short for Communication and Telemetry System[^1]. CATS aims to offer a similar functionality to the widely adopted but long-in-the-tooth Automatic Packet Reporting System (APRS), though the CATS protocol is designed to take advantage of the substantial improvements in inexpensive, off-the-shelf RF and embedded computing hardware available in the present day. I encourage readers to take a look at the [CATS Protocol Standard][], because much of what follows here will make little sense without first understanding the protocol. \
I have been following Stephen's development work with great interest. In my amateur career there has been very little to inspire interest in the UHF bands; these are ideal bands for reliable line-of-sight ranged communications, and because they're *so* predictable and reliable, they're *utterly boring* to me. Within the amateur radio community, nearly all activities on UHF amount to casual chatting using FM via repeaters, which I find to be dull as dishwater. Something is different about CATS though; it actually *solves a problem for me*, namely that I want to be able to chat with my ham friends on the bus or train but I don't want to make annoying noises with my [meat mouth](https://www.mit.edu/people/dpolicar/writing/prose/text/thinkingMeat.html) in order to do so, or blare out tinny audio of my friends guffawing for all around me to hear. I silently curse anyone who makes unnecessary noise on public transit, especially those using electronic noise-makers that pollute the air with irritating sounds which only the user enjoys, and which everyone else is too polite to say something about. I wince at the thought of selfishly adding to this cacophony. Among its many features, CATS supports the ability to send and receive SMS-style short text messages, which allows me to ~~shitpost~~ chat with my ham friends to my heart's content while also not disturbing the almighty peace. \
To this end, Stephen has been designing a device called the CATS Companion, an integrated CATS transceiver that incorporates a display and a new old stock Blackberry keyboard for text input. This is a stroke of genius; there's warehouses full of surplus Blackberry keyboards being sold for pennies on the dollar, and in my humble opinion no handheld device has ever equalled Blackberry for text input. I still sorely miss my own Blackberry Bold 9600, but that's neither here nor there. My point is, that a portable wireless text messaging device based on a keyboard I adore is under development, and I want this to happen so badly that I am willing to put in some effort to help develop it. I asked Stephen if there's anything I could do to hasten this project along, and he replied that he could use some help designing the transmitter's power amplifier. I jumped at the chance to contribute. Problem is, I don't know how to design a UHF power amplifier. The remainder of this post, and other posts to follow, will document my journey as I try to wring more and more decibels out of the apathetic silicon. 

### Feeling for the Shape of the Problem
CATS represents a pretty gentle starting point for a novice PA[^2] designer, all things considered. The modulation is plain 2-FSK, which is highly tolerant of amplifier nonlinearity. The transmitting frequency is fixed by the [CATS Protocol Standard][] at 430.500MHz, so narrowband and fixed-frequency design techniques are useful here. One interesting item specified in the standard is that the total ramp-up/ramp-down time of a transmission must be less than 1ms, including whatever transmit-receive switching action that has to happen. \
All of Stephen's current CATS transceivers are based on the Silicon Labs [Si4463][] integrated transceiver chip. The Si4463 datasheet claims a maximum output power of +20dBm (100mW) at 868MHz, drawing 85mA from its 3.6V supply. You can't just hook this chip up to an antenna and let it rip though, this maximum output power is not the raw output of the chip's TX pin into a 50 ohm load. Powers of +20dBm are only achievable by designing a matching network that squeezes every drop of RF power out of that TX pin. At the same time, the chip is outputting essentially a square wave on its TX pin rather than a sine wave[^3], so this matching network must also reduce the harmonic output to an acceptable level (how much harmonic attenuation is needed? I don't know that offhand). Silicon Labs offers two handy app-notes to serve as a starting point for matching network design, filled with detailed reference designs and recommendations; these are [AN648][] for high-powered designs and [AN627][] for low-powered designs. I am skimming these and will make notes of useful information as I find it. What this all amounts to is that for my PA design, I can expect an absolute maximum of +20dBm as input drive power, though in practice the drive power will probably be less than that. So I can localize the realistic range of input powers for my amplifier to the range of about 10-20dBm. The Si4463's output can be matched to 50 ohms, but I don't know whether that will be worth the effort. Harmonic suppression on the output of the Si4463 may not be necessary or even desirable if the signal is being fed to an inherently nonlinear amplifier. I'll note here that the Si4463 includes a pin, TXRAMP, which is disabled by default but which can be used to trigger an external amplifier if needed, this is described in section 5.4 of the [Si4463][] datasheet. \
The CATS Companion's power supply is based around a single cell rechargeable lithium battery, with a 3.7V nominal output voltage. For the logic devices there is an onboard buck/boost converter that takes the 3.7V from the lithium cell and boosts it to 5V. The buck/boost converter is rated for a maximum of 2A of output current at 5V, though it's possible that other limitations like the battery may kick in before this limit is reached. Still, it's good to know that the buck/boost converter is not likely to be the limiting factor here. I think it's plausible that we can derive the PA from the buck/boost converter output if needed, though if the output of the converter is noisy then this noise may modulate the transmitter output which is highly undesirable. \
For this PA, we want to achieve a reasonable output power (ideally 4-5W into a 50 ohm load) at a good efficiency for battery operation (70% or more). For the amplifying element itself, Stephen suggested the [RQA0009TXDQS][] MOSFET transistor, which is the heart of the infamous Baofeng UV-5R. For all that radio's faults, [an unreliable power amplifier is not one of them](https://www.youtube.com/watch?v=KqVq2G9dY5Q), so I am going along with this suggestion. Looking at the [RQA0009TXDQS][]'s datasheet, there's a number of helpful reference designs, of which the closest to my application are the three designs tested at 465MHz. Of particular note is the 465MHz design that uses a 4.8V supply (similar to what we'd get out of the 5V logic power rail supplied by the buck/boost converter) and an input power of +17dBm, obtaining an output power of 35.2dBm (3.3W), a quiescent drain current of 300mA (total drain current at input power +17dBm about 1100mA), and an efficiency of 60%. While it falls slightly short on the power and efficiency aspirations, this design is already a pretty good candidate for a PA that largely meets the requirements set out so far. There is another 465MHz reference design that uses a 3.6V supply (close to what we'd get out of a direct battery connection), and with a drive level of +20dBm (right at our upper limit for drive powers) it obtains a 33.1dBm (2.1W) output power at 66.4% efficiency, with a quiescent drain current of 200mA (total drain current at input power +20dBm is about 800mA); other than efficiency these characteristics are farther from the goals than the design with the 4.8V supply. The remaining 465MHz reference design uses a 7V supply and a +25dBm input power, which are outside the range of values that the CATS Companion's design can presently provide. I will dismiss this 7V design other than to point out that it obtains a good output power (39.0dBm/8W) and the best efficiency out of all designs at this frequency (67.9%), pointing to the benefits of using a higher supply voltage for this MOSFET. Overall I consider these results to be encouraging. 

### In Summary
Here I'll dump the requirements, constraints, and design goals for the PA that I have figured out so far, and their sources: 
- 50 ohm output impedance (duh)
- Input power no greater than 20dBm, probably in the range 10-20dBm ([Si4463][])
- Output frequency 430.500MHz ([CATS Protocol Standard][])
- Total ramp-up/ramp-down < 1ms ([CATS Protocol Standard][])
- Can be designed for either of the two voltage sources available: 3.7V from the battery or 5V from the buck/boost converter (informal discussions with Stephen)
- Max current from battery is unknown, max current from buck/boost converter 2A but may be bounded by the battery (informal discussions with Stephen)
- Desired output power 5W (arbitrary but reasonable goal)
- Desired efficiency > 70% (arbitrary but reasonable goal)
- Lower overall BOM cost than an RF4463 (RF transceiver module based on Si4463, including an integrated 1W PA) 

Here are the questions I have to ponder:
- What should the overall topology of the amplifier be? Class C, D, or E? What are the trade offs for each? 
- How should I match the Si4463's output to the PA's input? Is it worth designing the amp to have an input impedance of 50 ohms, and implement a matching network on the Si4463 to obtain a matching 50 ohm output? Or would it be better to directly match the Si4463's output impedance to the RQA0009TXDQS's input impedance? Can I get away with just connecting the square save output from the Si4463 directly to the RQA0009TXDQS's gate, and eat whatever mismatch loss that incurs?
- What level of harmonic suppression is necessary for legal use on the amateur bands? What are the exact rules about this for both Canada (where Stephen and I live), the USA (where many many potential CATS users live), and elsewhere?
- How much nonlinearity can 2-FSK with 4.8kHz deviation at 9600bd tolerate? Is this something I am going to have to worry about later, or can this concern be dismissed out of hand? 
- Should I power the PA directly from the 3.7V battery (which will have a lower power but basically guaranteed to be free of noise) or the 5V rail (which may be noisy and cause unwanted modulation of the signal)? 
- What is the model of buck/boost converter? I should have its datasheet around for reference
- Are there any aspects of the design that might cause the T/R switching time to exceed the <1ms specification? 
- For that matter; how is T/R switching even supposed to work here? This is a big unanswered question for me
- To what extent do the reference designs in the RQA0009TXDQS's datasheet represent the best achievable performance? Can the power output and/or efficiency of these designs be surpassed in this application?
- The [Si4463][] datasheet has "Not Recommended for New Designs" plastered all over it[^4]; how worried about this should we be? 

Overall, I am confident that the design goals for this PA can be met or at least closely approached within the constraints set by Stephen's design for the CATS Companion. I've still got a lot of work to do, though. 

[^1]: Not coincidentally, he's also a big fan of cats, the fuzzy animal.
[^2]: The term "power amplifier" is often abbreviated to PA, which is an abbreviation I will use freely throughout this text. No identification to the American state of Pennsylvania is intended or should be inferred. 
[^3]: From my quick skim of the Si4463 datasheet, I am not totally sure it's a square wave that it's outputting from the TX pin, but it's got to be pretty close to a square wave if they can load it up for class E operation.
[^4]: An older revision of the datasheet that is not plastered all over with this ominous warning can be found [here](https://docs.rs-online.com/3bcb/0900766b813b9ab9.pdf), if you find that more readable. I don't know how crucial the changes are between this revision and the most recent one are, so be warned. 

[CATS]: <https://cats.radio/>
[CATS Protocol Standard]: <https://gitlab.scd31.com/cats/cats-standard/-/blob/master/standard.pdf>
[Si4463]: <https://www.silabs.com/documents/public/data-sheets/Si4464-63-61-60.pdf>
[AN648]: <https://www.silabs.com/documents/public/application-notes/AN648.pdf>
[AN627]: <https://www.silabs.com/documents/public/application-notes/AN627.pdf>
[RQA0009TXDQS]: <https://www.renesas.com/us/en/document/dst/rqa0009txdqs-datasheet?language=en&r=1343766>
