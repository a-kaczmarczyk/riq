---
title: "Mitigating Multipath on HF Channels"
date: 2024-01-03T00:48:54-05:00
draft: true
---
Imagine there were beings who naturally developed the ability to emit and sense radio waves in the HF region, also known as shortwave. What methods would they evolve to communicate with each other? How would such communications sound, when these signals are shifted down to the audio range and turned into pressure waves in the air rather than EM waves? What sorts of clever tricks and optimizations could evolution come up with, which we humans couldn't imagine in a million years? \
I'd guess that the closest equivalent reality would be the songs of humpback whales, which propagate thousands of kilometres through the open ocean (whenever human activities do not harmfully interfere). I have no idea how our hypothetical HF-speaking beings would talk to each other, but in my mind's eye it might be something like the oddly haunting sounds of the humpback whales. What does this have to do with the rest of the discussion that follows? I hope that will become clear by the very end, though you will have to bear with me for a while. 

### Introduction to Multipath in a HF context
I have been considering the problem of multipath in HF data modems. An excellent starting point for this thinking is given by this handy ITU publication, [Rec. ITU-R F.1487][]. \
Briefly: multipath is a phenomenon where a radio signal transmitted at point A arrives at a receiver at point B over multiple paths (very creative name). Each path from A to B has a different length and thus a different amount of time delay as each individual ray travels at the speed of light. So, multiple copies of a transmitted signal arrive at the receiver with different time delays and interfere with themselves. Multipath induced time delays between individual rays are on the order of milliseconds on HF, with realistic values for a 2-ray model given in [Rec. ITU-R F.1487][] as between 0.5ms for a "Quiet Mid-Latitude" channel to up to 7ms for a "Disturbed High-Latitude" channel[^1]. \
Turning up the transmitted power doesn't help, because the desired signal is itself the source of this interference; any increase in the power of the desired ray will increase the power of the secondary (interfering) rays in exact proportion to the desired ray. It is thus possible to receive a high amount of power from a transmitter (relative to the background noise level) and still be unable to decode their signal, because of self-interference due to multipath. A less extreme version of this would be to initiate a data connection with a station that appears to be very strong, but the observed throughput is much less than one would guess given the apparent strength of the signal. This is somewhat analogous to echoing or reverberation in acoustics, where time-delayed copies of a spoken sentence can add up to make a combined sound that is much less intelligible than a sentence spoken at the same volume in a less echo-prone room. \
There are additional effects at play here: these multiple paths taken by the signal are refracted by the ionosphere's multiple layers, and these layers can change in height over time. Since now we're scattering waves off of a moving object, a frequency shift is inevitable due to the Dopler effect. There are two observable effects: the first is that each ray emitted by the transmitter has its frequency spectrum spread out due to rapid fluctuations along its own path, this known as Doppler spreading (of an *individual* ray) and it sets the limit of frequency resolution on ionospheric HF channels. The second effect is that each path taken by the signal is scattered off of different ionosphere layers at different locations with different velocities, so each ray is shifted in frequency by a different amount relative to the other rays; this is just Doppler shifting *between* rays. Referring again to [Rec. ITU-R F.1487][], Doppler spread values for HF channels are on the order of Hz, with 0.1Hz being representative of a "Quiet Mid-Latitude" channel, while on the opposite extreme we find 30Hz as representative of a "Disturbed High-Latitude". \
Also mentioned in the ITU paper is the splitting of the signal into multiple magneto-ionic components, which I will acknowledge here but do not fully understand. It reminds me of [birefringence](https://en.wikipedia.org/wiki/Birefringence) but I am not entirely sure whether that's the same effect. It looks like Magneto-ionic splitting can be considered another mechanism by which the transmitted signal can be split into separate rays, so it can be treated as a contributor to multipath impairment rather than its own category of impairment. I'll look more into this later. Magneto-ionic splitting is neglected for suggested HF channel simulations in Annex 2 of [Rec. ITU-R F.1487][] so I will likewise neglect this topic for now. \
In general, it's possible for there to be an arbitrary number of independent rays, each with their own Doppler shift, Doppler spread, and time delay. I will refer to all the different delays and Doppler shifts/spreads needed to specify a multipath-impaired channel as its *multipath profile*. Unless otherwise specified I will be implicitly evaluating things in terms of a 2-ray model where the multipath profile can be fully specified by just one time delay, one Doppler shift (separating the two rays in frequency) and two Doppler spreads (broadening the spectra of each ray by a different amount). This can be further simplified: Annex 2 of [Rec. ITU-R F.1487][] suggests that for the purposes of testing HF modems, it's sufficient to hold Doppler shift between the two rays at a fixed value (by default, 0Hz) throughout testing, and that the same Doppler spread value can be assigned to each ray, so really we only need to track two variables; the Doppler spread of both rays and the time delay between the two rays (with the Doppler shift being a global variable defined once and then held constant thereafter). A more general or realistic treatment of the situation may be required for other applications, but for comparative testing this is deemed sufficient by the ITU so I'll deem it sufficient for my mental modeling purposes. It also allows for nifty 3-dimensional graphs with time delay on one horizontal axis, Doppler spread on the other horizontal axis, and BER or SNR on the vertical axis.

### Multipath Mitigation Strategies
Multipath is a fact of life on HF, and any practical data modulation scheme used on HF channels must be at least somewhat tolerant of its effects. One obvious avenue for reducing multipath impairment is at the antenna. Using a steerable antenna with high unidirectional gain, or an antenna array with steerable lobes and nulls, these allow the transmitter or receiver (or ideally, both working in concert) to ensure that one path from the transmitter site to the receiver site overwhelmingly dominates all other paths, causing their interference to be negligible compared to the desired signal. Some interesting analytical work on multipath mitigation using diversity reception can be found in [this paper][New results for Shannon capacity over generalized multipath fading channels with MRC diversity]. This is all fine and good, but antennas or antenna arrays with such desirable directional properties are typically huge and expensive at HF frequencies. For the rest of this discussion I will assume that options based in antenna directivity and/or antenna diversity[^2] are unavailable or not effective enough on their own, which means we have to rely on the characteristics of the modulation scheme for multipath mitigation. \
Delay between one ray and another cause the resulting combined signal at the receiver to have overlapping symbols, smearing together the boundaries between one symbol and the next, which is referred to as inter-symbol interference or ISI. Modems designed for use over telephone lines (where this sort of multipath doesn't occur) can barely tolerate HF multipath conditions at the best of times; for example the classic Bell 103 300bd 2-FSK. 300bd corresponds to a symbol period of about 3.3ms, which is on the same order of magnitude as the multipath delay on a realistic HF channel. In the extreme case of a 7ms delay in a 2-ray model, the time difference between rays corresponds to two whole symbols of offset between one ray and the other. That is; for a given Bell 103 symbol transmitted in this scenario, this symbol will be overlapped by whatever the transmitter was sending two symbol periods ago. Bell 202 with its 1200bd 2-FSK (corresponding to about 0.83ms per symbol) would be utterly hopeless for all but the mildest 0.5ms delay scenario, and even then, over half of any given symbol's period will be marred by interference from the symbol carried by the other ray in a 2-ray model. \
All of this strongly suggests that ISI due to the time delay can be mitigated by using a lower symbol rate. Intuitively it seems to makes sense that drawing each symbol for a longer amount of time should reduce the ISI caused by any given amount of time delay. If the delay is much less than the symbol period, then the inter-symbol interference should be confined to a small percentage of the time after the symbol change has taken place, and for the remaining part of the symbol period the transmission only has to contend with interference from the same symbol that is currently being sent, and this interference can sometimes even be constructive if you're lucky and the rays happen to add up in phase. This heuristic of lowering the symbol rate is the only plausible answer I have seen for addressing the problem of multipath in modulation design, but it's really just a heuristic and not subject to some Information-Theoretic law like the Shannonâ€“Hartley theorem provides for AWGN channels. Lowering the symbol rate only addresses the problem of time-delay ISI, it doesn't do anything to address Doppler spread or shift. As best as I can tell, **no optimal modulation scheme is currently known for mitigating multipath effects on a RF channel**. Speculating wildly, it might well be that *increasing* the symbol rate might turn out to be the optimal strategy against multipath effects under as-yet unknown circumstances; I don't consider this outcome very *likely*, but I do want to illustrate that sometimes plausible sounding heuristics can mislead you from finding the truly optimal solution to a problem. 

### Empirical Studies
Without some grand theory to provide guidance, the first tool of any good scientist is to look for empirical data, and look for patterns in the data that could provide a clue. My starting point on this search for such data is [this HF modem performance comparison study][N5TW] by Tom Whiteside N5TW. In this study, Tom compares the performances of several HF modems that are currently or formerly in use on the [Winlink network](https://www.winlink.org/); [PACTOR 3 and 4 by SCS](https://www.scs-ptc.com/), [VARA HF by EA5HVK](https://rosmodem.wordpress.com/), [ARDOP (open source project initiated by the Winlink organization)](https://www.winlink.org/content/ardop_overview), and finally [WINMOR](https://winlink.org/sites/default/files/downloads/winmor_protocol_spec.pdf) which has been officially retired from use on the Winlink network due to its low performance compared to the other modes available [^3]. Modems with wideband (>2kHz) and narrowband (500Hz) sub-modes were evaluated and compared separately. This is the only publication I have been able to find so far that includes testing and comparison of amateur HF modems under different (simulated) HF channel which include multipath scenarios. The specific scenarios used in testing were given labels WGN (Wideband Gaussian Noise only, ie no multipath impairment), MPG (MultiPath Good) and MPP (MultiPath Poor)[^4]. \
While the performance comparisons and conclusions are interesting, the study does not provide fine-grained enough details to analyze specifically what about each modem contributed to its success or failure under the different test scenarios. Each of these modems includes a whole suite of different modulation types that are deployed under different circumstances to try and get the best available throughput for a given channel, but the results in this study are aggregated together without noting the specific behaviors of the modems under test. Also, as a minor annoyance, the source data for the plots is not provided in a numerical format (though in fairness I didn't bother reaching out to N5TW to ask him for that data), so I am giving my best eyeballed estimate of the throughput values read from the graphs. Considering each modem as a black box, we can still make observations about the results, beginning with the obvious: 
1. *All* modems under consideration experienced an overall reduction in throughput when switching from WGN to a multipath-impaired channel (either MPG or MPP). Stated another way, no modem benefitted from transmitting via the multipath channels over the WGN channel. 
2. At higher SNRs[^5], the throughput of a given modem is more strongly dependent on the multipath profile of the channel. 
3. As the SNR is decreased, the throughput of a given modem tends to become less dependent on the multipath profile of the channel. Examples: for VARA 2300 and Pactor 4, at SNRs of 5dB or less the throughputs of each modem seem to converge on the same value irrespective of the channel. Counterexample: PACTOR 2 maintains a clear dependence between throughput and multipath profile throughout the entire range of SNRs it was tested with. 
4. Some modems experienced a proportionately larger reduction in throughput than others when changing from a WGN channel to a multipath channel at the same SNR. Some extreme examples, all quoted at SNR = 30dB; PACTOR 4 is the least affected by multipath at this SNR with a reduction from 40kbyte/s on a WGN channel to 35kbyte/s over a MPP channel (fractionally, the MPP throughput is 87.5% that of the WGN throughput), whereas WINMOR 1600 is the most profoundly affected by multipath at this SNR, falling from 7.9kbyte/s over WGN to 2.6kbyte/s over MPP (33% of the WGN value for this SNR). 
5. Some modems experience nearly the same level of impairment from a MPG channel as they do for a MPP channel across a broad range of SNRs. Examples of this behavior include VARA 2300 (for SNRs below 25dB), PACTOR 4, ARDOP 2000, VARA 500, and WINMOR 500. For some of these cases, the MPP throughput sometimes even exceeds the MPG throughput by a small amount. 




[^1]: What if a HF signal goes all the way around the planet and interferes with itself that way? What would the time delay between the short-path ray and the long-path ray be? This could be considered an exotic form of multipath interference. This sort of thing has been known to occur rarely. As a toy model, I'll assume that the signal follows a Great Circle path and that it clings to the Earth's surface such that the contributions to the path length by bouncing between the ground and the ionosphere is essentially negligible. The circumference of the Earth along a Great Circle is very close to 40Mm (40 000km for those who can't remember their SI prefixes). The speed of light is denoted c = 300Mm/s. Say we have a short path distance S, and a long path distance L, such that L + S = 40Mm. The time that the short path takes to go from the transmitter to the receiver along the Earth's surface is S/c, while the long path takes L/c, so the time delay T = L/c - S/c. Substituting L = 40Mm - S, we can rephrase this entirely in terms of S: T = (40Mm - 2S)/c. One special case is when the transmitter and receiver are at antipodes, S = L = 20Mm, so T = (40Mm - 40Mm)/c = 0s so in this case all path lengths are equal and we have no time delay. On the opposite extreme, for stations that are a very small distance apart relative to the Earth's circumference, S ~ 0Mm so T = 40Mm/c = ~0.133s. This special case sets a reasonable upper bound on the maximum time delay for a single loop around the planet via a Great Circle path. So, multipath contributions from signals making a round-trip journey around the entire planet would have a time delay spread of 0-133ms according to this toy model. 

[^2]: Here's a profoundly different approach to the problem: a receiver with multiple phase-coherent antenna inputs can be configured as a [*Rake Receiver*](https://en.wikipedia.org/wiki/Rake_receiver). In a Rake Receiver, the received streams from each antenna input can be mathematically correlated to identify and isolate a selection of multipath rays; then each one of these rays can be individually analyzed and the results combined to help demodulate the original signal. In other words, a Rake Receiver connected to an appropriately diverse antenna array can often obtain *higher* signal quality and *lower* bit error rate than it otherwise could achieve by receiving just a single ray. I find this to be breathtakingly clever, and wonder a lot why this sort of approach is essentially unknown in the amateur HF world. Perhaps it's due to the lack of coherent multi-channel HF receivers on the market, which is something I have personally been thinking about a lot... 

[^3]: ARDOP is rapidly losing support on the Winlink network because of its very lackluster in performance compared to VARA and PACTOR 3/4, which is a shame because out of the modems I mentioned it's the only one that's both free and open source. At time of writing ARDOP is not yet retired but I can see it happening within a year or two, and after that the only modems left in use on the Winlink network will be closed-source and proprietary, which I think is in violation of the spirit of amateur radio. *That discussion* is a whole can of worms which should be reserved for another time. 

[^4]: The multipath scenarios offered by the [Teensy IONOS Simulator](https://winlink.org/content/ionos_simulator) used in N5TW's study look like they are directly based on models specified in [ITU-R F.520](https://www.itu.int/dms_pubrec/itu-r/rec/f/R-REC-F.520-2-199203-W!!PDF-E.pdf), which was a precursor to [Rec. ITU-R F.1487][]. For example, MPG corresponds to a "Good" channel in ITU-R F.520, which is renamed to "Mid-latitudes, Quiet" in ITU-R F.1487. The other multipath scenario tested was MPP, which are the same as a "Poor" channel as defined in ITU-R F.520, and which are close to but not quite the same as "Low latitudes, Moderate" the corresponding scenario in ITU-R F.1487 (the frequency spread is 1.0Hz for MPP/"Poor" vs 1.5Hz for "Low latitudes, Moderate") 

[^5]: Note that SNR here is determined by the amount of AWGN power added to the signal by the channel simulator, which is an orthogonal property to the multipath profile. The "effective SNR" as measured by a receiver under multipath conditions might be lower, depending on how it is calculated. This is purely a measure of how much signal power is delivered to the receiver in proportion to wideband noise power added to the channel, irrespective of how badly the signal itself might have been scrambled by multipath effects. 

[Rec. ITU-R F.1487]: <https://www.itu.int/dms_pubrec/itu-r/rec/f/R-REC-F.1487-0-200005-I!!PDF-E.pdf> 
[N5TW]: <https://www.winlink.org/sites/default/files/downloads/a_winlink_digital_mode_performance_comparison_based_on_the_ionis_sim_hf_vhf_channel_simulator_-_november_2_2020_0.pdf>
[An Introduction to Deep Learning for the Physical Layer]: <https://arxiv.org/abs/1702.00832>
[New results for Shannon capacity over generalized multipath fading channels with MRC diversity]: <https://jwcn-eurasipjournals.springeropen.com/counter/pdf/10.1186/1687-1499-2012-336.pdf>
